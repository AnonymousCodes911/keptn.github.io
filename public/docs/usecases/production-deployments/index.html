<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Production Deployments - keptn</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="google-site-verification" content="wDzKASaTgmwGTtV-z_O-NU_6e1wOgA7spKT96o9r8XE" />
  
  <link rel="icon" href="https://keptn.sh/favicon.png">

  
  
  <link rel="stylesheet" href="/css/style.min.821919e21a897e2d44560dc93ae95d622a07179547d0969419b46936cfcf90b5.css">
  <link rel="stylesheet" href="/js/libs/doc/lightbox/css/lightbox.min.min.1bbb47ec548f1c47e276ce27971cdc27f8c803ee4bb96f064c72c7448f7c0f12.css">
  
  <script>
    var branchName = "";
    var docTitle = "Production Deployments";
    var iconFile = "https:\/\/keptn.sh\//img/icons.svg";
    var buttonCopy = '';
    var buttonPrint = '';
    var buttonDownload = '';
  </script>
</head>

<body class='page '>
  
<div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-docs">
      <a href="/docs/">
        
        <span>Docs</span>
      </a>
    </li>
    
  </ul>
</div>

  <div class="wrapper">

    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://keptn.sh/"><img alt="Keptn Homepage" src="https://keptn.sh/images/logo.svg" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://keptn.sh/"><img alt="Keptn Homepage" src="https://keptn.sh/images/logo-mobile.svg" /></a>
    </div>
    
<div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-docs">
      <a href="/docs/">
        
        <span>Docs</span>
      </a>
    </li>
    
  </ul>
</div>

    
<button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" role="presentation" aria-label="mobile menu trigger">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>

  </div>
</div>
    <a href="https://github.com/keptn/" class="github-corner" aria-label="Keptn on GitHub">
  <svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true">
    <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z" fill="#151513"></path>
    <path class="octo-arm" d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="#ffffff" style="transform-origin: 130px 106px;"></path>
    <path class="octo-body" d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="#ffffff"></path>
  </svg>
</a>
    <div class="container">
      




    <div class="primary">


    <div id="sidebar-container" class="sidebar-container sidebar-offcanvas">
        
        
            <nav class="sidebar">
    <div class="spacer"></div>
    <div class="directory" role="tablist">
        

        
        

        
            
        
            
        
            

                <div class="card">
                    <div class="card-header" role="tab" id="header2">
                        <a data-toggle="collapse" href="#collapse2" title="How to deploy keptn in Kubernetes." role="button" aria-controls="collapse2">
                            <div><svg class="icon"><use xlink:href="/img/icons.svg#setup"/></svg>Setup</div>
                        </a>
                    </div>

                    <div id="collapse2" class="collapse" role="tabpanel" aria-labelledby="header2">
                        <div class="card-body">
                            




<ul class="tree">
    
        
    
        
            
                <li class="sublist">
                    

                    <label class='tree-toggle'><i class="chevron show"><svg class="icon"><use xlink:href="/img/icons.svg#right-chevron"/></svg></i><i class="chevron"><svg class="icon"><use xlink:href="/img/icons.svg#down-chevron"/></svg></i><a  title="Instructions for installing keptn on Kubernetes." href="https://keptn.sh/docs/setup/kubernetes/">Kubernetes</a>
                    </label>

                    




<ul class="tree collapse">
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
            
                <li>
                    
                        <a title="Demonstrates how to install keptn in a Kubernetes cluster on Google Container Engine (GKE)." href="https://keptn.sh/docs/setup/kubernetes/install-keptn-v.0.1/">Install keptn v.0.1 on GKE</a>
                    
                </li>
             
        
    
</ul>

                </li>
            
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
</ul>

                        </div>
                    </div>
                </div>
            
        
            
        
            
        
            
        
            
        
            

                <div class="card">
                    <div class="card-header" role="tab" id="header7">
                        <a data-toggle="collapse" href="#collapse7" title="How to do specific targeted activities with keptn." role="button" aria-controls="collapse7">
                            <div><svg class="icon"><use xlink:href="/img/icons.svg#tasks"/></svg>Use Cases</div>
                        </a>
                    </div>

                    <div id="collapse7" class="collapse show" role="tabpanel" aria-labelledby="header7">
                        <div class="card-body">
                            




<ul class="tree">
    
        
    
        
    
        
    
        
            
                <li>
                    
                        <a title="Shows you how to setup a fully automated on-demand self-service model for performance testing." href="https://keptn.sh/docs/usecases/performance-as-a-service/">Performance as a Service</a>
                    
                </li>
             
        
    
        
            
                <li>
                    
                        <span class="current" title="Gives an overview of production deployments, deployment strategies, and depicts those using Istio on Kubernetes to canary-deploy a new front-end version.">Production Deployments</span>
                    
                </li>
             
        
    
        
            
                <li>
                    
                        <a title="Gives an overview of how to leverage the power of runbook automation to build self-healing applications. Therefore, you will use Ansible Tower as the tool for executing and managing the runbooks." href="https://keptn.sh/docs/usecases/runbook-automation-and-self-healing/">Runbook Automation and Self-healing</a>
                    
                </li>
             
        
    
        
            
                <li>
                    
                        <a title="Shows you how to implement a delivery pipeline that prevents bad code changes from impacting your end users." href="https://keptn.sh/docs/usecases/unbreakable-delivery-pipeline/">Unbreakable Delivery Pipeline</a>
                    
                </li>
             
        
    
        
    
        
    
</ul>

                        </div>
                    </div>
                </div>
            
        
            
        

        
            
        
    </div>
</nav>

        
    </div>

    <div class="article-container">
        
            <label class="sidebar-toggler" id="sidebar-toggler" title=''>
                <svg class="icon"><use xlink:href="/img/icons.svg#pull"/></svg>
            </label>
        

        <div class="pagenav">
            <p>


    
        
        
        
    

    
        
        
        
    

    
        
        
        
    

    
        
        
        
    




    
    
    

    
        <a href="https://keptn.sh/">Home</a>
        <span>/</span>
    

    
    
    

    
        <a href="https://keptn.sh/docs/">Docs</a>
        <span>/</span>
    

    
    
    

    
        <a href="https://keptn.sh/docs/usecases/">Use Cases</a>
        <span>/</span>
    

    
    
    

    
        Production Deployments
    

</p>
        </div>

        <main aria-labelledby="title">
            <h1 id="title">Production Deployments</h1>

            

            
                <p class="byline"><span title="%!(EXTRA int=1572)"><svg class="icon"><use xlink:href="/img/icons.svg#clock"/></svg><span>&nbsp;</span>%!(EXTRA int=8)</span></p>
            

            
                <nav class="toc-inlined">
                    <hr/>
                    <div class="directory" role="directory">
                        











    
    

    
        
        <nav id="InlinedTableOfContents">
            <ul>
                
                
                    
                    
                    
                    

                    

                    <li><a href="#about-this-use-case">About this use case</a></li>

                    
                
                    
                    
                    
                    

                    

                    <li><a href="#step-1-verify-istio-installation-and-deploy-sockshop-to-production">Step 1: Verify Istio installation and deploy sockshop to production</a></li>

                    
                
                    
                    
                    
                    

                    

                    <li><a href="#step-2-access-ingress-gateway">Step 2: Access ingress gateway</a></li>

                    
                
                    
                    
                    
                    

                    

                    <li><a href="#step-3-create-front-end-v2">Step 3. Create front-end v2</a></li>

                    
                
                    
                    
                    
                    

                    

                    <li><a href="#step-4-deploy-front-end-v2-to-production">Step 4. Deploy front-end v2 to production</a></li>

                    
                
                    
                    
                    
                    

                    

                    <li><a href="#step-5-istio-traffic-routing">Step 5. Istio traffic routing</a></li>

                    
                
                    
                    
                    
                    

                    
                        
                        
                            <ul>
                        
                    

                    <li><a href="#optional-redirect-only-logged-in-users">(optional) Redirect only logged in users</a></li>

                    
                
                    
                    
                    
                    

                    

                    <li><a href="#optional-redirect-only-chrome-users">(optional) Redirect only Chrome users</a></li>

                    
                
                    
                    
                    
                    

                    
                        
                        
                            </ul>
                        
                    

                    <li><a href="#step-6-cleanup">Step 6. Cleanup</a></li>

                    
                
                    
                    
                    
                    

                    

                    <li><a href="#understanding-what-happened">Understanding what happened</a></li>

                    
                

                
                

                
            </ul>
        </nav>
    


                    </div>
                    <hr/>
                </nav>
            



<p>This use case gives an overview of production deployments, deployment strategies, and depicts those using Istio on Kubernetes to canary-deploy a new front-end version.</p>

<h2 id="about-this-use-case">About this use case</h2>

<p>When developing an application, sooner or later you need to update a service in a production environment. To conduct this in a controlled manner and without impacting end-user experience,  deployment strategies must be in place. For example, blue-green or canary deployment are well known strategies to rollout a new service version. Additionally, these strategies keep the previous service available if something goes wrong.</p>

<p>To illustrate the benefit this use case addresses, you will create a second version of the front-end service, which has another background color in the header component. Then, this version will be deployed to the production environment in a dark-launch manner. To route traffic to this new service version, the configuration of a virtual service will be changed by setting weights for the routes. In other words, this configuration change defines how much traffic is routed to the old and to the new version of the front-end service.</p>

<p>Optionally, you can try the additional virtual service configurations that redirect signed-in users or users with a Chrome browser to the new front-end version.</p>


<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="//www.youtube.com/embed/IFegk6BtN8I" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>


<h2 id="step-1-verify-istio-installation-and-deploy-sockshop-to-production">Step 1: Verify Istio installation and deploy sockshop to production</h2>

<ol>
<li><p>To verify the installation of Istio, execute the <code>kubectl get services -n istio-system</code> command:</p>

<pre><code class="language-console">$ kubectl get services -n istio-system
NAME                     TYPE           CLUSTER-IP      EXTERNAL-IP     PORT(S)                                          AGE
grafana                  ClusterIP      10.23.248.137   &lt;none&gt;          3000/TCP                                         10h
istio-citadel            ClusterIP      10.23.245.163   &lt;none&gt;          8060/TCP,9093/TCP                                10h
istio-egressgateway      ClusterIP      10.23.250.121   &lt;none&gt;          80/TCP,443/TCP                                   10h
istio-galley             ClusterIP      10.23.246.195   &lt;none&gt;          443/TCP,9093/TCP                                 10h
istio-ingressgateway     LoadBalancer   10.23.245.251   **.184.232.**   80:31380/TCP,443:31390/TCP,31400:31400/TCP,...   10h
istio-pilot              ClusterIP      10.23.242.171   &lt;none&gt;          15010/TCP,15011/TCP,8080/TCP,9093/TCP            10h
istio-policy             ClusterIP      10.23.245.9     &lt;none&gt;          9091/TCP,15004/TCP,9093/TCP                      10h
istio-sidecar-injector   ClusterIP      10.23.255.240   &lt;none&gt;          443/TCP                                          10h
istio-telemetry          ClusterIP      10.23.244.185   &lt;none&gt;          9091/TCP,15004/TCP,9093/TCP,42422/TCP            10h
</code></pre></li>

<li><p>Ensure that the label <code>istio-injection</code> has only been applied to the production namespace by executing the <code>kubectl get namespace -L istio-injection</code> command:</p>

<pre><code class="language-console">$ kubectl get namespace -L istio-injection
NAME           STATUS    AGE       ISTIO-INJECTION
cicd           Active    10h
default        Active    10h
dev            Active    10h
dynatrace      Active    10h
istio-system   Active    10h        disabled
kube-public    Active    10h
kube-system    Active    10h
production     Active    10h        enabled
staging        Active    10h
</code></pre></li>

<li><p>Trigger the <code>k8s-deploy-production</code> pipeline in your Jenkins instance (see :one:). This promotes all components that are currently in the <em>staging</em> namespace to the <em>production</em> namespace.</p>

<p><img src="./assets/trigger-k8s-deploy-production.png" alt="trigger k8s-deploy-production" /></p>

<p>This pipeline reads the current versions of all artefacts in the <em>staging</em> namespace and deploys those artefacts in the exact same version to the <em>production</em> namespace. Instead of pushing individual microservices to production, we chose the approach of defining a release bracket, which holds versions of microservices that work together well.</p></li>
</ol>

<h2 id="step-2-access-ingress-gateway">Step 2: Access ingress gateway</h2>

<ol>
<li><p>Run the <code>kubectl get svc istio-ingressgateway -n istio-system</code> command to get the <em>EXTERNAL-IP</em> of your <em>Gateway</em>.</p>

<pre><code class="language-console">$ kubectl get svc istio-ingressgateway -n istio-system
NAME                   TYPE           CLUSTER-IP       EXTERNAL-IP     PORT(S)                                      AGE
istio-ingressgateway   LoadBalancer   172.21.109.129   1**.2**.1**.1**  80:31380/TCP,443:31390/TCP,31400:31400/TCP   17h
</code></pre></li>
</ol>

<h2 id="step-3-create-front-end-v2">Step 3. Create front-end v2</h2>

<p>In this step, you create an <em>improved</em> version of the front-end service. You will change the color of the application header to see the effect of traffic routing between two different artefact versions.</p>

<ol>
<li><p>Edit the file <code>public/topbar.html</code> in the master branch of the <code>~/keptn/repositories/front-end</code> repository and change the following lines as depicted in the screenshot:</p>

<p><img src="./assets/change-topbar-html.png" alt="change-topbar-html" /></p></li>

<li><p>Save the changes to that file.</p></li>

<li><p>Now it&rsquo;s time to commit your changes; first locally, and then push it to the remote repository.</p>

<pre><code class="language-console">$ git add .
$ git commit -m &quot;New more colorful version of front-end service&quot;
$ git push
</code></pre></li>

<li><p>You need the new version of the <code>front-end</code> service in the <em>staging</em> namespace, before you can start with a blue-green or canary deployment. Therefore, create a new release branch in the <code>front-end</code> repository using our Jenkins pipeline:</p>

<ol>
<li>Go to <strong>Jenkins</strong> and <strong>sockshop</strong>.</li>
<li>Click on <strong>create-release-branch</strong> pipeline and <strong>Schedule a build with parameters</strong>.</li>

<li><p>For the parameter <strong>SERVICE</strong>, enter the name of the service you want to create a release for. In this case: <strong>front-end</strong></p>

<p>The pipeline does the following:</p>

<ol>
<li>Reads the current version of the microservice.</li>
<li>Creates a release branch with the name release/<strong>version</strong>.</li>
<li>Increments the current version by 1.</li>
<li>Commits/Pushes the new version to the Git repository.</li>
</ol>

<p><img src="./assets/pipeline_release_branch.png" alt="pipeline_release_branch" /></p></li>
</ol></li>

<li><p>After the <strong>create-release-branch</strong> pipeline has finished, trigger the build pipeline for the <code>front-end</code> service and wait until the new artefacts is deployed to the <em>staging</em> namespace.</p>

<ul>
<li>Wait until the release/<strong>version</strong> build has finished.</li>
</ul></li>

<li><p>To see your changes in the <code>front-end</code> service that is deployed in <em>staging</em>, get the <em>EXTERNAL-IP</em> of the <code>front-end</code> load balancer in <em>staging</em> by listing all services in that namespace.</p>

<pre><code class="language-console">$ kubectl -n staging get services
NAME           TYPE            CLUSTER-IP       EXTERNAL-IP         PORT(S)
carts          ClusterIP       10.11.250.175    &lt;none&gt;              80/TCP
catalogue      ClusterIP       10.11.254.135    &lt;none&gt;              80/TCP
front-end      LoadBalancer    10.11.249.245    1**.2**.3**.4**     8080:31481/TCP
orders         ClusterIP       10.11.251.11     &lt;none&gt;              80/TCP
payment        ClusterIP       10.11.248.211    &lt;none&gt;              80/TCP
queue-master   ClusterIP       10.11.242.139    &lt;none&gt;              80/TCP
rabbitmq       ClusterIP       10.11.255.201    &lt;none&gt;              5672/TCP,9090/TCP
shipping       ClusterIP       10.11.244.162    &lt;none&gt;              80/TCP
user           ClusterIP       10.11.245.147    &lt;none&gt;              80/TCP
user-db-svc    ClusterIP       10.11.243.25     &lt;none&gt;              27017/TCP
</code></pre>

<p>Enter the public IP (e.g., 1<strong>.2</strong>.3<strong>.4</strong>:8080) in your browser and you see the visual improvements you did.</p>

<p><img src="./assets/frontend-v2.png" alt="frontend-v2" /></p></li>
</ol>

<h2 id="step-4-deploy-front-end-v2-to-production">Step 4. Deploy front-end v2 to production</h2>

<p>In this step, you will promote the new version of the <code>front-end</code> service to production.</p>

<ol>
<li><p>In your Jenkins instance, trigger the parameterized pipeline <code>k8s-deploy-production.update</code> (see :one:).</p>

<p><img src="./assets/trigger-production-update.png" alt="trigger-production-update" /></p></li>

<li><p>Enter <code>front-end</code> as service name and <code>v2</code> as new version when asked for parameters to that pipeline.</p>

<p><img src="./assets/enter-parameters.png" alt="enter-parameters" /></p>

<p>This pipeline reads the version of the passed service in the <em>staging</em> namespace and deploys the artefact in that version to the <em>production</em> namespace in a deployment with the passed version number. After running that pipeline, two deployments of <code>front-end</code> (one with <em>v1</em> and one with <em>v2</em>) are available.</p>

<pre><code class="language-console">$ kubectl -n production get deployment
NAME           DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
...
front-end-v1   1         1         1            1           10h
front-end-v2   1         1         1            1           32s
...
</code></pre>

<p>At this stage, the <strong>VirtualService</strong> for sockshop is configured to use <em>v1</em> initially. So, the application is not affected at all by the deployment of a new version in the <em>production</em> namespace. You can check the details of the deployments to see that each deployment uses a different artefact version, e.g. <code>0.5.0</code> and <code>0.6.0</code>, in the example below:</p>

<pre><code class="language-console">$ kubectl -n production describe deployment front-end-v1
...
Pod Template:
Labels:  app=front-end
         version=v1
Containers:
front-end:
    Image:      10.11.249.13:5000/library/sockshop/front-end-0.5.0
    Port:       8080/TCP
    Host Port:  0/TCP
...
</code></pre>

<pre><code class="language-console">$ kubectl -n production describe deployment front-end-v2
...
Pod Template:
Labels:  app=front-end
         version=v2
Containers:
front-end:
    Image:      10.11.249.13:5000/library/sockshop/front-end-0.6.0
    Port:       8080/TCP
    Host Port:  0/TCP
...
</code></pre></li>
</ol>

<h2 id="step-5-istio-traffic-routing">Step 5. Istio traffic routing</h2>

<p>In this step, you will configure traffic routing in Istio to redirect traffic based on different criteria to <em>v2</em> of the <code>front-end</code> service. It addresses the tasks to redirect traffic using weight rules, redirect only logged in users, and to redirect only Chrome users to v2.</p>

<ol>
<li><p>Right now, traffic to <code>front-end</code> is routed to <em>v1</em> due to the configuration of the <strong>VirtualService</strong>. The <code>subset: v1</code> entry in the configuration takes care of that.</p>

<p>```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
name: sockshop
spec:
hosts:</p>

<ul>
<li>&ldquo;*&rdquo;
gateways:</li>
<li>sockshop-gateway
http:</li>
<li>route:

<ul>
<li>destination:
host: front-end.production.svc.cluster.local
subset: v1
```</li>
</ul></li>
</ul></li>

<li><p>To see if the new version works properly, 10% of the traffic can be redirected to that version. Therefore, it is necessary to modify the <code>virtual-service-canary.yml</code> in the <code>~/keptn/repositories/k8s-deploy-production/istio</code> repository and to apply it.</p>

<pre><code class="language-console">$ pwd
~/repositories/k8s-deploy-production/istio
$ vi virtual-service-canary.yml
...
</code></pre>

<p>Edit the file like this:</p>

<p><strong>!Note! YOU MUST NOT DELETE THE COMMENTS #v1 AND #v2 - THE COMMENTS ARE NEEDED LATER ON</strong></p>

<p><img src="./assets/modify-canary-yml.png" alt="modify-canary-yml" /></p>

<p>This configuration redirects 10% of all traffic hitting the sockshop <strong>VirtualService</strong> to version 2.</p></li>

<li><p>Apply the changes by executing the command <code>kubectl apply -f virtual_service_canary.yml</code></p>

<pre><code class="language-console">$ kubectl apply -f virtual_service_canary.yml
virtualservice.networking.istio.io/sockshop configured
</code></pre></li>

<li><p>To verify the configuration change, open the ingress gateway and refresh the page a couple of times. You should notice that about every tenth hit redirects you to the new version (<em>v2</em>) showing a blue header.</p></li>
</ol>

<h3 id="optional-redirect-only-logged-in-users">(optional) Redirect only logged in users</h3>

<ol>
<li><p>You can decide traffic routing also based on information that is included in the HTTP header. For example, you can present <em>v2</em> only to users that are logged in. See the following configuration that enables that:</p>

<p>```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
name: sockshop
spec:
hosts:</p>

<ul>
<li>&ldquo;*&rdquo;
gateways:</li>
<li>sockshop-gateway
http:</li>
<li>match:

<ul>
<li>headers:
cookie:
regex: &ldquo;.<em>logged_in.</em>&ldquo;
route:</li>
<li>destination:
host: front-end.production.svc.cluster.local
subset: v2</li>
</ul></li>
<li>route:

<ul>
<li>destination:
host: front-end.production.svc.cluster.local
subset: v1
```</li>
</ul></li>
</ul>

<p>Istio checks if the cookie field of the HTTP header contains the string <code>logged_in</code> using regular expressions. This, of course, depends on the implementation of your web application and is not universally applicable.</p></li>

<li><p>Apply the changes by executing the command <code>kubectl apply -f virtual_service_v2_for_users.yml</code></p>

<pre><code class="language-console">$ kubectl apply -f virtual_service_v2_for_users.yml
virtualservice.networking.istio.io/sockshop configured
</code></pre></li>

<li><p>If you login using either a new registered user, or a user that you&rsquo;ve created before, you see version 2. After logging out, you see verison 1 again.</p></li>
</ol>

<h3 id="optional-redirect-only-chrome-users">(optional) Redirect only Chrome users</h3>

<ol>
<li><p>Another option is to redirect traffic based on the used browser. See the following configuration that enables that:</p>

<p>```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
name: sockshop
spec:
hosts:</p>

<ul>
<li>&ldquo;*&rdquo;
gateways:</li>
<li>sockshop-gateway
http:</li>
<li>match:

<ul>
<li>headers:
user-agent:
regex: &ldquo;.<em>Chrome.</em>&ldquo;
route:</li>
<li>destination:
host: front-end.production.svc.cluster.local
subset: v2</li>
</ul></li>
<li>route:

<ul>
<li>destination:
host: front-end.production.svc.cluster.local
subset: v1
```</li>
</ul></li>
</ul></li>

<li><p>Apply the changes by executing the command <code>kubectl apply -f virtual_service_v2_for_chrome.yml</code></p>

<pre><code class="language-console">$ kubectl apply -f virtual_service_v2_for_chrome.yml
virtualservice.networking.istio.io/sockshop configured
</code></pre></li>

<li><p>If you open sockshop using Chrome you see version 2, with any other browser version 1 is displayed.</p></li>
</ol>

<h2 id="step-6-cleanup">Step 6. Cleanup</h2>

<ol>
<li><p>Apply the configuration of the <strong>VirtualService</strong> to use v1 only.</p>

<pre><code class="language-console">$ cd ~/keptn/repositories/k8s-deploy-production/istio
$ kubectl apply -f virtual_service.yml
virtualservice.networking.istio.io/sockshop configured
</code></pre></li>
</ol>

<h2 id="understanding-what-happened">Understanding what happened</h2>

<p>In this use case, you deployed a new service version into production and used Istio to redirect traffic towards the new and old version.</p>




            
        </main>

        
            <div class="pagenav">
                <div class="left">
                    
                        <p>
                            <a title="Shows you how to setup a fully automated on-demand self-service model for performance testing." href="https://keptn.sh/docs/usecases/performance-as-a-service/"><svg class="icon"><use xlink:href="/img/icons.svg#left-arrow"/></svg>Performance as a Service</a>
                        </p>
                    
                </div>
                <div class="right">
                    
                        <p>
                            <a title="Gives an overview of how to leverage the power of runbook automation to build self-healing applications. Therefore, you will use Ansible Tower as the tool for executing and managing the runbooks." href="https://keptn.sh/docs/usecases/runbook-automation-and-self-healing/">Runbook Automation and Self-healing<svg class="icon"><use xlink:href="/img/icons.svg#right-arrow"/></svg></a>
                        </p>
                    
                </div>
            </div>
        

        <div class="link-endnotes" aria-hidden="true">
            <h2></h2>
            <ol id="endnotes"></ol>
        </div>
    </div>

    
        <div class="toc-container">
            <nav class="toc">
                <div class="spacer"></div>
                <div id="toc" class="directory" role="directory">
                    











    
    

    
        
        <nav id="TableOfContents">
            <ul>
                
                
                    
                    
                    
                    

                    

                    <li><a href="#about-this-use-case">About this use case</a></li>

                    
                
                    
                    
                    
                    

                    

                    <li><a href="#step-1-verify-istio-installation-and-deploy-sockshop-to-production">Step 1: Verify Istio installation and deploy sockshop to production</a></li>

                    
                
                    
                    
                    
                    

                    

                    <li><a href="#step-2-access-ingress-gateway">Step 2: Access ingress gateway</a></li>

                    
                
                    
                    
                    
                    

                    

                    <li><a href="#step-3-create-front-end-v2">Step 3. Create front-end v2</a></li>

                    
                
                    
                    
                    
                    

                    

                    <li><a href="#step-4-deploy-front-end-v2-to-production">Step 4. Deploy front-end v2 to production</a></li>

                    
                
                    
                    
                    
                    

                    

                    <li><a href="#step-5-istio-traffic-routing">Step 5. Istio traffic routing</a></li>

                    
                
                    
                    
                    
                    

                    
                        
                        
                            <ul>
                        
                    

                    <li><a href="#optional-redirect-only-logged-in-users">(optional) Redirect only logged in users</a></li>

                    
                
                    
                    
                    
                    

                    

                    <li><a href="#optional-redirect-only-chrome-users">(optional) Redirect only Chrome users</a></li>

                    
                
                    
                    
                    
                    

                    
                        
                        
                            </ul>
                        
                    

                    <li><a href="#step-6-cleanup">Step 6. Cleanup</a></li>

                    
                
                    
                    
                    
                    

                    

                    <li><a href="#understanding-what-happened">Understanding what happened</a></li>

                    
                

                
                

                
            </ul>
        </nav>
    


                </div>
            </nav>
        </div>
    
</div>



  </div>

  <div class="footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="footer-inner">
          <img alt="Keptn" src="https://keptn.sh/images/logo_white.svg" class="footer-logo"/><h3 class="footer-title">built with <span style="font-size: 1.8rem">&#x2665;</span> by Dynatrace</h3>
          <ul class="footer-menu">
            <li><a href="https://github.com/keptn/" target="_blank"><img alt="github" src="https://keptn.sh/social/github.svg" /></a></li>
            <li><a href="https://keptn.slack.com/" target="_blank"><img alt="slack" src="https://keptn.sh/social/slack.svg" /></a></li>
            <li><a href="https://twitter.com/keptnproject" target="_blank"><img alt="twitter" src="https://keptn.sh/social/twitter.svg" /></a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li><strong>Email: </strong><a href="mailto:keptn@dynatrace.com">
                keptn@dynatrace.com</a></li>
          </ul>
          <ul>
            <li class="zerostatic"><a href="https://keptn.sh">keptn.sh</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  
  
  
  
  
  
  

  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>

  
  <script type="text/javascript" src="/js/scripts.min.6d111557349b327a23f49ebbca651db173a6db206c8251e177fc4ffa955c2831.js"></script>
  <script type="text/javascript" src="/js/libs/doc/utils.min.e4f6edf1fb4538897beb4a38589df56162c9a3786e26dcac1eba43e5f136f104.js"></script>
  <script type="text/javascript" src="/js/libs/doc/misc.min.ed496662b7e3100b5a0fb8aff7eb00424b75ab3ffc1e06528004efb2529153f5.js"></script>
  <script type="text/javascript" src="/js/libs/doc/prism.min.ccc0e2507ebaf84f84a022e4628fd98c50c9c636e3c447653b6c813f04258344.js"></script>
  <script type="text/javascript" src="/js/libs/doc/lightbox/js/lightbox-plus-jquery.min.min.caa0181254e65ca8b51c5db7115641bd56796eeb7236589c6d6e1785cfb37e9d.js"></script>
  

  

  
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-133584243-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'UA-133584243-1');
  </script>



</body>

</html>